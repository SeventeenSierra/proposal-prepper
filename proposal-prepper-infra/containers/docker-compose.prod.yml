# SPDX-License-Identifier: PolyForm-Perimeter-1.0.0
# SPDX-FileCopyrightText: 2025 Seventeen Sierra LLC

# Production-specific Docker Compose overrides
version: '3.8'

services:
  web:
    # Production build configuration
    build:
      target: production
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    # Remove development volumes
    volumes: []
    # Production command
    command: npm start
    # Stricter health checks for production
    healthcheck:
      interval: 60s
      timeout: 15s
      start_period: 120s
      retries: 3
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  strands:
    # Production build configuration
    build:
      target: production
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - LOG_TO_FILE=true
    # Remove development volumes
    volumes:
      - ../src/seed-data:/app/src/seed-data:ro
    # Production command
    command: python -m uvicorn main:app --host 0.0.0.0 --port 8080 --workers 4
    # Stricter health checks for production
    healthcheck:
      interval: 60s
      timeout: 15s
      start_period: 120s
      retries: 3
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  postgres:
    # Production database configuration
    environment:
      - POSTGRES_LOG_STATEMENT=none
      - POSTGRES_LOG_MIN_DURATION_STATEMENT=-1
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  redis:
    # Production Redis configuration with enhanced persistence
    volumes:
      - redis_data:/data
      - ./redis-prod.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  minio:
    # Production MinIO configuration
    environment:
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_URL:-http://localhost:9001}
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'