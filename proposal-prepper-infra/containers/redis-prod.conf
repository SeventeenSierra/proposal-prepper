# SPDX-License-Identifier: PolyForm-Perimeter-1.0.0
# SPDX-FileCopyrightText: 2025 Seventeen Sierra LLC

# Redis configuration for production environment
# Optimized for reliability and data persistence

# =============================================================================
# PERSISTENCE CONFIGURATION (MAXIMUM DURABILITY)
# =============================================================================

# Enable AOF with maximum durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Fsync every second for good balance

# AOF rewrite configuration for production
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Enable RDB snapshots for backup
save 900 1      # Save if at least 1 key changed in 900 seconds
save 300 10     # Save if at least 10 keys changed in 300 seconds  
save 60 10000   # Save if at least 10000 keys changed in 60 seconds

# RDB file configuration
dbfilename dump.rdb
dir /data

# Stop writes if RDB snapshots fail (safety)
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes
rdbchecksum yes

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Production memory limit
maxmemory 512mb
maxmemory-policy allkeys-lru

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

bind 0.0.0.0
port 6379
tcp-keepalive 300

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_b835c3b4e5f8a3d2c1e9f7a6b4d8e2c1"

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

loglevel notice
logfile ""

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

protected-mode no
tcp-backlog 511
timeout 0

# Disable keyspace notifications in production for performance
# notify-keyspace-events ""

# =============================================================================
# PRODUCTION RELIABILITY
# =============================================================================

# Enable lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Replica settings (for future clustering)
replica-lazy-flush yes