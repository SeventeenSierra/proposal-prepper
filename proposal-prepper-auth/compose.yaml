# SPDX-License-Identifier: PolyForm-Strict-1.0.0
# SPDX-FileCopyrightText: 2025 Seventeen Sierra LLC

# Keycloak Authentication Microservice
version: '3.8'

services:
  keycloak:
    build:
      context: .
      dockerfile: Containerfile
    container_name: proposal-prepper-auth
    ports:
      - "8180:8080"  # Keycloak on 8180 (avoid conflict with analysis-engine)
    environment:
      # Database connection
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/proposal_prepper
      - KC_DB_USERNAME=postgres
      - KC_DB_PASSWORD=password
      - KC_DB_SCHEMA=keycloak
      
      # Admin credentials (development only)
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      
      # Hostname configuration
      - KC_HOSTNAME=localhost
      - KC_HOSTNAME_PORT=8180
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      
      # Proxy configuration
      - KC_PROXY=edge
      
      # Logging
      - KC_LOG_LEVEL=INFO
      
    volumes:
      - ./config:/opt/keycloak/data/import:ro
      - keycloak_data:/opt/keycloak/data/h2
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      start_period: 90s
      retries: 5
      
    restart: unless-stopped
    
    networks:
      - proposal-prepper-network

networks:
  proposal-prepper-network:
    external: true
    name: proposal-prepper-network

volumes:
  keycloak_data:
    driver: local
    name: ${COMPOSE_PROJECT_NAME:-proposal-prepper}_keycloak_data
