# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Seventeen Sierra LLC

name: License Compliance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  npm-licenses:
    name: npm License Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check licenses
        run: |
          npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense;WTFPL;Python-2.0' --excludePrivatePackages || echo "::warning::Some packages have incompatible licenses"

  scancode:
    name: Deep License Scan (ScanCode)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ScanCode
        run: pip install scancode-toolkit
      
      - name: Scan vendor directory
        run: |
          if [ -d "vendor" ]; then
            scancode --license --copyright --output-json vendor-licenses.json vendor/
          else
            echo "No vendor directory found, skipping"
          fi
      
      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: vendor-licenses.json
          if-no-files-found: ignore
